services:
  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./apps/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./apps/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./apps/nginx/html:/usr/share/nginx/html:ro
    depends_on:
      - n8n
      - nextcloud
      - uptime-kuma
      - immich-server
      - homeassistant
      - jellyfin
      - pihole
    healthcheck:
      test: ['CMD', 'nginx', '-t']
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - home_apps

  n8n:
    build:
      context: .
      dockerfile: apps/n8n/Dockerfile
    container_name: n8n
    restart: unless-stopped
    expose:
      - "5678"
    environment:
      - N8N_HOST=localhost
      - N8N_SECURE_COOKIE=false
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=America/New_York
      - N8N_DIAGNOSTICS_ENABLED=false
      # SQLite configuration
      - DB_SQLITE_POOL_SIZE=3
      - DB_SQLITE_ENABLE_WAL=true
      # Task runners configuration
      - N8N_RUNNERS_ENABLED=true
      # Security settings
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
    volumes:
      - n8n_data:/home/node/.n8n
    healthcheck:
      test: ['CMD-SHELL', 'wget --spider -q http://localhost:5678/healthz || exit 1']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - home_apps

  nextcloud:
    image: nextcloud:apache
    container_name: nextcloud
    restart: unless-stopped
    expose:
      - "80"
    environment:
      - MYSQL_HOST=nextcloud-db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud_password
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=admin
      - NEXTCLOUD_TRUSTED_DOMAINS=nextcloud.localhost
      - OVERWRITEPROTOCOL=http
      - OVERWRITEHOST=nextcloud.localhost
    volumes:
      - nextcloud_data:/var/www/html
    depends_on:
      nextcloud-db:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost/status.php']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - home_apps

  nextcloud-db:
    image: mariadb:10.11
    container_name: nextcloud-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=nextcloud_root_password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud_password
    volumes:
      - nextcloud_db:/var/lib/mysql
    healthcheck:
      test: ['CMD', 'healthcheck.sh', '--connect', '--innodb_initialized']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - home_apps

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    expose:
      - "3001"
    volumes:
      - uptime_kuma_data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    healthcheck:
      test: ['CMD-SHELL', 'node -e "require(\"http\").get(\"http://localhost:3001/api/health\", (r) => process.exit(r.statusCode === 200 ? 0 : 1))"']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    networks:
      - home_apps

  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-server
    restart: unless-stopped
    expose:
      - "2283"
    environment:
      - DB_HOSTNAME=immich-db
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
      - IMMICH_MACHINE_LEARNING_URL=http://immich-machine-learning:3003
      - IMMICH_HOST=0.0.0.0
      - TZ=America/New_York
    volumes:
      - immich_upload:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      immich-db:
        condition: service_healthy
      immich-redis:
        condition: service_healthy
    healthcheck:
      test: ['CMD-SHELL', 'wget --spider -q http://localhost:2283/api/server/ping || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - home_apps

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-machine-learning
    restart: unless-stopped
    expose:
      - "3003"
    volumes:
      - immich_model_cache:/cache
    environment:
      - TZ=America/New_York
    healthcheck:
      test: ['CMD-SHELL', 'python3 -c "import urllib.request; urllib.request.urlopen(\"http://localhost:3003/ping\")" || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    networks:
      - home_apps

  immich-redis:
    image: redis:7-alpine
    container_name: immich-redis
    restart: unless-stopped
    volumes:
      - immich_redis:/data
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - home_apps

  immich-db:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    container_name: immich-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=immich
      - POSTGRES_INITDB_ARGS=--data-checksums
    volumes:
      - immich_db:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -d immich -U postgres']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - home_apps

  homeassistant:
    image: homeassistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    expose:
      - "8123"
    environment:
      - TZ=America/New_York
    volumes:
      - ./apps/homeassistant:/config
      - /etc/localtime:/etc/localtime:ro
    privileged: true
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:8123/ || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - home_apps

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    expose:
      - "8096"
    environment:
      - TZ=America/New_York
      - JELLYFIN_PublishedServerUrl=http://jellyfin.localhost
    volumes:
      - jellyfin_config:/config
      - jellyfin_cache:/cache
      - jellyfin_media:/media
      - /etc/localtime:/etc/localtime:ro
    healthcheck:
      test: ['CMD-SHELL', 'curl -f http://localhost:8096/health || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    networks:
      - home_apps

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    expose:
      - "80"
    environment:
      - TZ=America/New_York
      - WEBPASSWORD=changeme
      - VIRTUAL_HOST=pihole.localhost
      - FTLCONF_dns_listeningMode=all
    volumes:
      - pihole_data:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
    cap_add:
      - NET_ADMIN
    healthcheck:
      test: ['CMD-SHELL', 'dig +short +norecurse +retry=0 @127.0.0.1 pi.hole || exit 1']
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - home_apps

volumes:
  n8n_data:
    driver: local
  nextcloud_data:
    driver: local
  nextcloud_db:
    driver: local
  uptime_kuma_data:
    driver: local
  immich_upload:
    driver: local
  immich_model_cache:
    driver: local
  immich_redis:
    driver: local
  immich_db:
    driver: local
  jellyfin_config:
    driver: local
  jellyfin_cache:
    driver: local
  jellyfin_media:
    driver: local
  pihole_data:
    driver: local
  pihole_dnsmasq:
    driver: local

networks:
  home_apps:
    driver: bridge
