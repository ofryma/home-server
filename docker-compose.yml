services:

  # traefik:
  #   image: traefik:v3
  #   container_name: traefik
  #   ports:
  #     - "80:80"
  #     - "443:443"
  #     # (Optional) Expose Dashboard
  #     - "8080:8080"  # Don't do this in production!
  #   volumes:
  #     - ./apps/traefik:/etc/traefik
  #     - /var/run/docker.sock:/var/run/docker.sock
  #   environment:
  #     - DOCKER_HOST=unix:///var/run/docker.sock
  #   networks:
  #     - home_apps

  nginx:
    image: nginx:alpine
    container_name: nginx
    restart: unless-stopped
    ports:
      - "80:80"
    volumes:
      - ./apps/nginx/conf.d:/etc/nginx/conf.d:ro
    depends_on:
      - n8n
      - nextcloud
      - uptime-kuma
      - immich-server
      - homeassistant
      - jellyfin
      - pihole
      - code-server
      - homepage
      - portainer
      - pulse
      - ghostfolio
      - netdata
      - vaultwarden
    networks:
      - home_apps

  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:latest
    container_name: nginx-proxy-manager
    restart: unless-stopped
    ports:
      - "8080:80"   # HTTP (moved from 80)
      - "443:443"   # HTTPS
      - "81:81"     # NPM Admin UI
    volumes:
      - npm_data:/data
      - npm_letsencrypt:/etc/letsencrypt
    networks:
      - home_apps

  n8n:
    build:
      context: .
      dockerfile: apps/n8n/Dockerfile
    image: ghcr.io/${GITHUB_REPOSITORY:-ofrymakdasy/home-server}/n8n:latest
    container_name: n8n
    restart: unless-stopped
    expose:
      - "5678"
    ports:
      - "5678:5678"
    environment:
      - N8N_HOST=n8n.local
      - N8N_SECURE_COOKIE=false
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_PATH=/n8n/
      - NODE_ENV=production
      - WEBHOOK_URL=http://n8n.local/n8n/
      - GENERIC_TIMEZONE=America/New_York
      - N8N_DIAGNOSTICS_ENABLED=false
      # SQLite configuration
      - DB_SQLITE_POOL_SIZE=3
      - DB_SQLITE_ENABLE_WAL=true
      # Task runners configuration
      - N8N_RUNNERS_ENABLED=true
      # Security settings
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_GIT_NODE_DISABLE_BARE_REPOS=true
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - home_apps
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.entrypoints=web"
      - "traefik.http.routers.n8n.rule=Host(`ofryma.mooo.com`)"

  nextcloud:
    image: nextcloud:apache
    container_name: nextcloud
    restart: unless-stopped
    expose:
      - "80"
    environment:
      - MYSQL_HOST=nextcloud-db
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud_password
      - NEXTCLOUD_ADMIN_USER=admin
      - NEXTCLOUD_ADMIN_PASSWORD=admin
      - NEXTCLOUD_TRUSTED_DOMAINS=*
      - OVERWRITEPROTOCOL=http
      - OVERWRITEWEBROOT=/nextcloud
      - OVERWRITECLIURL=http://localhost/nextcloud
    volumes:
      - nextcloud_data:/var/www/html
    depends_on:
      - nextcloud-db
    networks:
      - home_apps

  nextcloud-db:
    image: mariadb:10.11
    container_name: nextcloud-db
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=nextcloud_root_password
      - MYSQL_DATABASE=nextcloud
      - MYSQL_USER=nextcloud
      - MYSQL_PASSWORD=nextcloud_password
    volumes:
      - nextcloud_db:/var/lib/mysql
    networks:
      - home_apps

  uptime-kuma:
    image: louislam/uptime-kuma:1
    container_name: uptime-kuma
    restart: unless-stopped
    expose:
      - "3001"
    volumes:
      - uptime_kuma_data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - home_apps

  immich-server:
    image: ghcr.io/immich-app/immich-server:release
    container_name: immich-server
    restart: unless-stopped
    ports:
      - "2283:2283"
    environment:
      - DB_HOSTNAME=immich-db
      - DB_USERNAME=postgres
      - DB_PASSWORD=postgres
      - DB_DATABASE_NAME=immich
      - REDIS_HOSTNAME=immich-redis
      - IMMICH_MACHINE_LEARNING_URL=http://immich-machine-learning:3003
      - IMMICH_HOST=0.0.0.0
      - TZ=America/New_York
    volumes:
      - immich_upload:/usr/src/app/upload
      - /etc/localtime:/etc/localtime:ro
    depends_on:
      - immich-db
      - immich-redis
    networks:
      - home_apps

  immich-machine-learning:
    image: ghcr.io/immich-app/immich-machine-learning:release
    container_name: immich-machine-learning
    restart: unless-stopped
    expose:
      - "3003"
    volumes:
      - immich_model_cache:/cache
    environment:
      - TZ=America/New_York
    networks:
      - home_apps

  immich-redis:
    image: redis:7-alpine
    container_name: immich-redis
    restart: unless-stopped
    volumes:
      - immich_redis:/data
    networks:
      - home_apps

  immich-db:
    image: tensorchord/pgvecto-rs:pg14-v0.2.0
    container_name: immich-db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=immich
      - POSTGRES_INITDB_ARGS=--data-checksums
    volumes:
      - immich_db:/var/lib/postgresql/data
    networks:
      - home_apps

  homeassistant:
    image: homeassistant/home-assistant:stable
    container_name: homeassistant
    restart: unless-stopped
    ports:
      - "8123:8123"
    environment:
      - TZ=America/New_York
    volumes:
      - ./apps/homeassistant:/config
      - /etc/localtime:/etc/localtime:ro
    privileged: true
    networks:
      - home_apps

  jellyfin:
    image: jellyfin/jellyfin:latest
    container_name: jellyfin
    restart: unless-stopped
    expose:
      - "8096"
    environment:
      - TZ=America/New_York
      - JELLYFIN_PublishedServerUrl=http://jellyfin.local
    volumes:
      - jellyfin_config:/config
      - jellyfin_cache:/cache
      - jellyfin_media:/media
      - /etc/localtime:/etc/localtime:ro
    networks:
      - home_apps

  pihole:
    image: pihole/pihole:latest
    container_name: pihole
    restart: unless-stopped
    ports:
      - "53:53/tcp"
      - "53:53/udp"
      - "8053:80"  # Pi-hole Web UI
    environment:
      - TZ=America/New_York
      - WEBPASSWORD=changeme
      - VIRTUAL_HOST=localhost
      - FTLCONF_dns_listeningMode=all
      - FTLCONF_misc_etc_dnsmasq_d=true
    volumes:
      - pihole_data:/etc/pihole
      - pihole_dnsmasq:/etc/dnsmasq.d
      - ./apps/pihole/custom-dns.conf:/etc/dnsmasq.d/02-custom-dns.conf:ro
    cap_add:
      - NET_ADMIN
    networks:
      - home_apps

  code-server:
    build:
      context: .
      dockerfile: apps/code-server/Dockerfile
    image: ghcr.io/${GITHUB_REPOSITORY:-ofrymakdasy/home-server}/code-server:latest
    container_name: code-server
    restart: unless-stopped
    expose:
      - "8443"
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
      - PASSWORD=changeme
      - SUDO_PASSWORD=changeme
      - DEFAULT_WORKSPACE=/config/workspace
    volumes:
      - code_server_config:/config
      - code_server_workspace:/config/workspace
    networks:
      - home_apps

  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: homepage
    restart: unless-stopped
    expose:
      - "3000"
    environment:
      - TZ=America/New_York
      - PUID=1000
      - PGID=1000
      - HOMEPAGE_ALLOWED_HOSTS=*
    volumes:
      - ./apps/homepage:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    user: "1000:999"  # user:docker-group
    networks:
      - home_apps

  portainer:
    image: portainer/portainer-ce:latest
    container_name: portainer
    restart: unless-stopped
    expose:
      - "9000"
    environment:
      - TZ=America/New_York
    volumes:
      - portainer_data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - home_apps

  pulse:
    image: rcourtman/pulse:latest
    container_name: pulse
    restart: unless-stopped
    expose:
      - "7655"
    ports:
      - "7655:7655"
    environment:
      - TZ=America/New_York
    volumes:
      - pulse_data:/app/data
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - home_apps

  ghostfolio:
    image: ghostfolio/ghostfolio:latest
    container_name: ghostfolio
    restart: unless-stopped
    expose:
      - "3333"
    ports:
      - "3333:3333"
    environment:
      - NODE_ENV=production
      - TZ=America/New_York
      - DATABASE_URL=postgresql://ghostfolio:ghostfolio@ghostfolio-db:5432/ghostfolio?sslmode=prefer
      - REDIS_HOST=ghostfolio-redis
      - REDIS_PORT=6379
      - ACCESS_TOKEN_SALT=changeme_random_salt_32_chars
      - JWT_SECRET_KEY=changeme_random_jwt_secret_key
      - BASE_CURRENCY=USD
    depends_on:
      - ghostfolio-db
      - ghostfolio-redis
    networks:
      - home_apps

  ghostfolio-db:
    image: postgres:15-alpine
    container_name: ghostfolio-db
    restart: unless-stopped
    environment:
      - POSTGRES_DB=ghostfolio
      - POSTGRES_USER=ghostfolio
      - POSTGRES_PASSWORD=ghostfolio
    volumes:
      - ghostfolio_db:/var/lib/postgresql/data
    networks:
      - home_apps

  ghostfolio-redis:
    image: redis:7-alpine
    container_name: ghostfolio-redis
    restart: unless-stopped
    volumes:
      - ghostfolio_redis:/data
    networks:
      - home_apps

  netdata:
    image: netdata/netdata:latest
    container_name: netdata
    hostname: home-server
    restart: unless-stopped
    expose:
      - "19999"
    environment:
      - TZ=America/New_York
    cap_add:
      - SYS_PTRACE
      - SYS_ADMIN
    security_opt:
      - apparmor:unconfined
    volumes:
      - netdata_config:/etc/netdata
      - netdata_lib:/var/lib/netdata
      - netdata_cache:/var/cache/netdata
      - /etc/passwd:/host/etc/passwd:ro
      - /etc/group:/host/etc/group:ro
      - /etc/localtime:/etc/localtime:ro
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /etc/os-release:/host/etc/os-release:ro
      - /var/log:/host/var/log:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - home_apps

  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    expose:
      - "80"
    environment:
      - TZ=America/New_York
      - DOMAIN=http://localhost/vaultwarden
      - ROCKET_PORT=80
      - ADMIN_TOKEN=changeme
      - SIGNUPS_ALLOWED=true
    volumes:
      - vaultwarden_data:/data
    networks:
      - home_apps

  watchtower:
    image: containrrr/watchtower:latest
    container_name: watchtower
    restart: unless-stopped
    environment:
      - TZ=America/New_York
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - WATCHTOWER_INCLUDE_STOPPED=false
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_ROLLING_RESTART=true
      - WATCHTOWER_NOTIFICATIONS=shoutrrr
      - WATCHTOWER_NOTIFICATION_URL=${WATCHTOWER_NOTIFICATION_URL:-}
      - REPO_USER=${GITHUB_USERNAME:-}
      - REPO_PASS=${GITHUB_TOKEN:-}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /etc/localtime:/etc/localtime:ro
    networks:
      - home_apps
    labels:
      - "com.centurylinklabs.watchtower.enable=true"

volumes:
  npm_data:
    driver: local
  npm_letsencrypt:
    driver: local
  n8n_data:
    driver: local
  nextcloud_data:
    driver: local
  nextcloud_db:
    driver: local
  uptime_kuma_data:
    driver: local
  immich_upload:
    driver: local
  immich_model_cache:
    driver: local
  immich_redis:
    driver: local
  immich_db:
    driver: local
  jellyfin_config:
    driver: local
  jellyfin_cache:
    driver: local
  jellyfin_media:
    driver: local
  pihole_data:
    driver: local
  pihole_dnsmasq:
    driver: local
  code_server_config:
    driver: local
  code_server_workspace:
    driver: local
  portainer_data:
    driver: local
  pulse_data:
    driver: local
  ghostfolio_db:
    driver: local
  ghostfolio_redis:
    driver: local
  netdata_config:
    driver: local
  netdata_lib:
    driver: local
  netdata_cache:
    driver: local
  vaultwarden_data:
    driver: local

networks:
  home_apps:
    driver: bridge
